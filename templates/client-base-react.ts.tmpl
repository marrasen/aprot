// Code generated by aprot. DO NOT EDIT.

import { useState, useEffect, useContext{{- if .HasTasks}}, useCallback{{end}}, createContext } from 'react';

{{template "error-codes" .}}

{{template "api-error" .}}

{{template "types" .}}

{{template "get-websocket-url" .}}

{{template "api-client-class" .}}

{{template "react-context" .}}

{{template "react-hook-types" .}}
{{- range .Interfaces}}

export interface {{.Name}} {
{{- range .Fields}}
    {{.Name}}{{if .Optional}}?{{end}}: {{.Type}};
{{- end}}
}
{{- end}}
{{- range .PushEvents}}

export function {{.HandlerName}}(client: ApiClient, handler: PushHandler<{{.DataType}}>): () => void {
    return client.onPush<{{.DataType}}>('{{.Name}}', handler);
}
{{- end}}
{{- if .HasTasks}}

// Shared task hooks
export function useSharedTasks(): SharedTaskState[] {
    const client = useApiClient();
    const [tasks, setTasks] = useState<SharedTaskState[]>([]);

    useEffect(() => {
        return client.onPush<TaskStateEvent>('TaskStateEvent', (event) => {
            setTasks(event.tasks);
        });
    }, [client]);

    return tasks;
}

export function useSharedTask(id: string): SharedTaskState | null {
    const tasks = useSharedTasks();
    return tasks.find(t => t.id === id) ?? null;
}

export function useMyTasks(): SharedTaskState[] {
    const tasks = useSharedTasks();
    return tasks.filter(t => t.isOwner && !t.parentId);
}

export function useTaskOutput(taskId: string): { lines: string[]; clear: () => void } {
    const client = useApiClient();
    const [lines, setLines] = useState<string[]>([]);

    useEffect(() => {
        return client.onPush<TaskUpdateEvent>('TaskUpdateEvent', (event) => {
            if (event.taskId === taskId && event.output != null) {
                setLines((prev) => [...prev, event.output!]);
            }
        });
    }, [client, taskId]);

    const clear = useCallback(() => setLines([]), []);

    return { lines, clear };
}

export function cancelSharedTask(client: ApiClient, taskId: string): Promise<void> {
    return client.request<void>('taskCancelHandler.CancelTask', [{ taskId }]);
}
{{- end}}
