{{- /* Shared template blocks for the tasks convenience code */ -}}

{{define "react-hooks"}}

// Shared task hooks
export function useSharedTasks(): SharedTaskState[] {
    const client = useApiClient();
    const [tasks, setTasks] = useState<SharedTaskState[]>([]);

    useEffect(() => {
        return client.onPush<TaskStateEvent>('TaskStateEvent', (event) => {
            setTasks(event.tasks);
        });
    }, [client]);

    return tasks;
}

export function useSharedTask(id: string): SharedTaskState | null {
    const tasks = useSharedTasks();
    return tasks.find(t => t.id === id) ?? null;
}

export function useMyTasks(): SharedTaskState[] {
    const tasks = useSharedTasks();
    return tasks.filter(t => t.isOwner && !t.parentId);
}

export function useTaskOutput(taskId: string): { lines: string[]; clear: () => void } {
    const client = useApiClient();
    const [lines, setLines] = useState<string[]>([]);

    useEffect(() => {
        return client.onPush<TaskUpdateEvent>('TaskUpdateEvent', (event) => {
            if (event.taskId === taskId && event.output != null) {
                setLines((prev) => [...prev, event.output!]);
            }
        });
    }, [client, taskId]);

    const clear = useCallback(() => setLines([]), []);

    return { lines, clear };
}
{{- end}}

{{define "meta-interfaces"}}
{{- range .MetaInterfaces}}

export interface {{.Name}} {
{{- range .Fields}}
    {{.Name}}{{if .Optional}}?{{end}}: {{.Type}};
{{- end}}
}
{{- end}}
{{- end}}
